(function(e){function n(){this._curInst=null;this._disabledFields=[];this._keypadShowing=false;this._keyCode=0;this._specialKeys=[];this.addKeyDef("CLOSE","close",function(t){e.keypad._curInst=t._inline?t:e.keypad._curInst;e.keypad._hideKeypad()});this.addKeyDef("CLEAR","clear",function(t){e.keypad._clearValue(t)});this.addKeyDef("BACK","back",function(t){e.keypad._backValue(t)});this.addKeyDef("SHIFT","shift",function(t){e.keypad._shiftKeypad(t)});this.addKeyDef("SPACE_BAR","spacebar",function(t){e.keypad._selectValue(t," ")},true);this.addKeyDef("SPACE","space");this.addKeyDef("HALF_SPACE","half-space");this.addKeyDef("ENTER","enter",function(t){e.keypad._selectValue(t,"\r")},true);this.addKeyDef("TAB","tab",function(t){e.keypad._selectValue(t,"	")},true);this.qwertyAlphabetic=["qwertyuiop","asdfghjkl","zxcvbnm"];this.qwertyLayout=["!@#$%^&*()_="+this.HALF_SPACE+this.SPACE+this.CLOSE,this.HALF_SPACE+"`~[]{}<>\\|/"+this.SPACE+"789","qwertyuiop'\""+this.HALF_SPACE+"456",this.HALF_SPACE+"asdfghjkl;:"+this.SPACE+"123",this.SPACE+"zxcvbnm,.?"+this.SPACE+this.HALF_SPACE+"-0+",""+this.TAB+this.ENTER+this.SPACE_BAR+this.SHIFT+this.HALF_SPACE+this.BACK+this.CLEAR];this.regional=[];this.regional[""]={buttonText:"...",buttonStatus:"Open the keypad",closeText:"Close",closeStatus:"Close the keypad",clearText:"Clear",clearStatus:"Erase all the text",backText:"Back",backStatus:"Erase the previous character",spacebarText:" ",spacebarStatus:"Space",enterText:"Enter",enterStatus:"Carriage return",tabText:"→",tabStatus:"Horizontal tab",shiftText:"Shift",shiftStatus:"Toggle upper/lower case characters",alphabeticLayout:this.qwertyAlphabetic,fullLayout:this.qwertyLayout,isAlphabetic:this.isAlphabetic,isNumeric:this.isNumeric,isRTL:false};this._defaults={showOn:"focus",buttonImage:"",buttonImageOnly:false,showAnim:"show",showOptions:{},duration:"normal",appendText:"",useThemeRoller:false,keypadClass:"",prompt:"",layout:["123"+this.CLOSE,"456"+this.CLEAR,"789"+this.BACK,"-0."],separator:"",target:null,keypadOnly:true,randomiseAlphabetic:false,randomiseNumeric:false,randomiseOther:false,randomiseAll:false,beforeShow:null,onKeypress:null,onClose:null};e.extend(this._defaults,this.regional[""]);this.mainDiv=e('<div class="'+this._mainDivClass+'" style="display: none;"></div>')}function r(t,n){e.extend(t,n);for(var r in n){if(n[r]==null||n[r]==undefined){t[r]=n[r]}}return t}var t="keypad";e.extend(n.prototype,{markerClassName:"hasKeypad",_mainDivClass:"keypad-popup",_inlineClass:"keypad-inline",_appendClass:"keypad-append",_triggerClass:"keypad-trigger",_disableClass:"keypad-disabled",_inlineEntryClass:"keypad-keyentry",_coverClass:"keypad-cover",setDefaults:function(e){r(this._defaults,e||{});return this},addKeyDef:function(e,t,n,r){if(this._keyCode==32){throw"Only 32 special keys allowed"}this[e]=String.fromCharCode(this._keyCode++);this._specialKeys.push({code:this[e],id:e,name:t,action:n,noHighlight:r});return this},_attachKeypad:function(t,n){var r=t.nodeName.toLowerCase()!="input"&&t.nodeName.toLowerCase()!="textarea";var i={_inline:r,_mainDiv:r?e('<div class="'+this._inlineClass+'"></div>'):e.keypad.mainDiv,ucase:false};i.settings=e.extend({},n||{});this._setInput(t,i);this._connectKeypad(t,i);if(r){e(t).append(i._mainDiv).bind("click.keypad",function(){i._input.focus()});this._updateKeypad(i)}else if(e(t).is(":disabled")){this._disableKeypad(t)}},_setInput:function(t,n){n._input=e(!n._inline?t:this._get(n,"target")||'<input type="text" class="'+this._inlineEntryClass+'" disabled="disabled"/>');if(n._inline){t=e(t);t.find("input").remove();if(!this._get(n,"target")){t.append(n._input)}}},_connectKeypad:function(n,r){var i=e(n);if(i.hasClass(this.markerClassName)){return}var s=this._get(r,"appendText");var o=this._get(r,"isRTL");if(s){i[o?"before":"after"]('<span class="'+this._appendClass+'">'+s+"</span>")}if(!r._inline){var u=this._get(r,"showOn");if(u=="focus"||u=="both"){i.focus(this._showKeypad).keydown(this._doKeyDown)}if(u=="button"||u=="both"){var a=this._get(r,"buttonText");var f=this._get(r,"buttonStatus");var l=this._get(r,"buttonImage");var c=e(this._get(r,"buttonImageOnly")?e('<img src="'+l+'" alt="'+f+'" title="'+f+'"/>'):e('<button type="button" title="'+f+'"></button>').html(l==""?a:e('<img src="'+l+'" alt="'+f+'" title="'+f+'"/>')));i[o?"before":"after"](c);c.addClass(this._triggerClass).click(function(){if(e.keypad._keypadShowing&&e.keypad._lastField==n){e.keypad._hideKeypad()}else{e.keypad._showKeypad(n)}return false})}}r.saveReadonly=i.attr("readonly");i.addClass(this.markerClassName)[this._get(r,"keypadOnly")?"attr":"removeAttr"]("readonly",true).bind("setData.keypad",function(e,t,n){r.settings[t]=n}).bind("getData.keypad",function(e,t){return this._get(r,t)});e.data(n,t,r)},_destroyKeypad:function(n){var r=e(n);if(!r.hasClass(this.markerClassName)){return}var i=e.data(n,t);if(this._curInst==i){this._hideKeypad()}r.siblings("."+this._appendClass).remove().end().siblings("."+this._triggerClass).remove().end().prev("."+this._inlineEntryClass).remove();r.empty().unbind("focus",this._showKeypad).removeClass(this.markerClassName)[i.saveReadonly?"attr":"removeAttr"]("readonly",true);e.removeData(i._input[0],t);e.removeData(n,t)},_enableKeypad:function(n){var r=e(n);if(!r.hasClass(this.markerClassName)){return}var i=n.nodeName.toLowerCase();if(i=="input"||i=="textarea"){n.disabled=false;r.siblings("button."+this._triggerClass).each(function(){this.disabled=false}).end().siblings("img."+this._triggerClass).css({opacity:"1.0",cursor:""})}else if(i=="div"||i=="span"){r.children("."+this._disableClass).remove();var s=e.data(n,t);s._mainDiv.find("button").attr("disabled","")}this._disabledFields=e.map(this._disabledFields,function(e){return e==n?null:e})},_disableKeypad:function(n){var r=e(n);if(!r.hasClass(this.markerClassName)){return}var i=n.nodeName.toLowerCase();if(i=="input"||i=="textarea"){n.disabled=true;r.siblings("button."+this._triggerClass).each(function(){this.disabled=true}).end().siblings("img."+this._triggerClass).css({opacity:"0.5",cursor:"default"})}else if(i=="div"||i=="span"){var s=r.children("."+this._inlineClass);var o=s.offset();var u={left:0,top:0};s.parents().each(function(){if(e(this).css("position")=="relative"){u=e(this).offset();return false}});r.prepend('<div class="'+this._disableClass+'" style="width: '+s.outerWidth()+"px; height: "+s.outerHeight()+"px; left: "+(o.left-u.left)+"px; top: "+(o.top-u.top)+'px;"></div>');var a=e.data(n,t);a._mainDiv.find("button").attr("disabled","disabled")}this._disabledFields=e.map(this._disabledFields,function(e){return e==n?null:e});this._disabledFields[this._disabledFields.length]=n},_isDisabledKeypad:function(t){return t&&e.inArray(t,this._disabledFields)>-1},_changeKeypad:function(n,i,s){var o=i||{};if(typeof i=="string"){o={};o[i]=s}var u=e.data(n,t);if(u){if(this._curInst==u){this._hideKeypad()}r(u.settings,o);this._setInput(e(n),u);this._updateKeypad(u)}},_showKeypad:function(n){n=n.target||n;if(e.keypad._isDisabledKeypad(n)||e.keypad._lastField==n){return}var r=e.data(n,t);e.keypad._hideKeypad(null,"");e.keypad._lastField=n;e.keypad._pos=e.keypad._findPos(n);e.keypad._pos[1]+=n.offsetHeight;var i=false;e(n).parents().each(function(){i|=e(this).css("position")=="fixed";return!i});if(i&&e.browser.opera){e.keypad._pos[0]-=document.documentElement.scrollLeft;e.keypad._pos[1]-=document.documentElement.scrollTop}var s={left:e.keypad._pos[0],top:e.keypad._pos[1]};e.keypad._pos=null;r._mainDiv.css({position:"absolute",display:"block",top:"-1000px",width:e.browser.opera?"1000px":"auto"});e.keypad._updateKeypad(r);s=e.keypad._checkOffset(r,s,i);r._mainDiv.css({position:i?"fixed":"absolute",display:"none",left:s.left+"px",top:s.top+"px"});var o=e.keypad._get(r,"showAnim");var u=e.keypad._get(r,"duration");u=u=="normal"&&e.ui&&e.ui.version>="1.8"?"_default":u;var a=function(){e.keypad._keypadShowing=true;var t=e.keypad._getBorders(r._mainDiv);r._mainDiv.find("iframe."+e.keypad._coverClass).css({left:-t[0],top:-t[1],width:r._mainDiv.outerWidth(),height:r._mainDiv.outerHeight()})};if(e.effects&&e.effects[o]){var f=r._mainDiv.data();for(var l in f){if(l.match(/^ec\.storage\./)){f[l]=r._mainDiv.css(l.replace(/ec\.storage\./,""))}}r._mainDiv.data(f).show(o,e.keypad._get(r,"showOptions"),u,a)}else{r._mainDiv[o||"show"](o?u:"",a)}if(!o){a()}if(r._input[0].type!="hidden"){r._input[0].focus()}e.keypad._curInst=r},_updateKeypad:function(e){var t=this._getBorders(e._mainDiv);e._mainDiv.empty().append(this._generateHTML(e)).find("iframe."+this._coverClass).css({left:-t[0],top:-t[1],width:e._mainDiv.outerWidth(),height:e._mainDiv.outerHeight()});e._mainDiv.removeClass().addClass(this._get(e,"keypadClass")+(this._get(e,"useThemeRoller")?" ui-widget ui-widget-content":"")+(this._get(e,"isRTL")?" keypad-rtl":"")+" "+(e._inline?this._inlineClass:this._mainDivClass));var n=this._get(e,"beforeShow");if(n){n.apply(e._input?e._input[0]:null,[e._mainDiv,e])}},_getBorders:function(t){var n=function(t){var n=e.browser.msie?1:0;return{thin:1+n,medium:3+n,thick:5+n}[t]||t};return[parseFloat(n(t.css("border-left-width"))),parseFloat(n(t.css("border-top-width")))]},_checkOffset:function(t,n,r){var i=t._input?this._findPos(t._input[0]):null;var s=window.innerWidth||document.documentElement.clientWidth;var o=window.innerHeight||document.documentElement.clientHeight;var u=document.documentElement.scrollLeft||document.body.scrollLeft;var a=document.documentElement.scrollTop||document.body.scrollTop;if(e.browser.msie&&parseInt(e.browser.version,10)<7||e.browser.opera){var f=0;t._mainDiv.find(":not(div,iframe)").each(function(){f=Math.max(f,this.offsetLeft+e(this).outerWidth()+parseInt(e(this).css("margin-right"),10))});t._mainDiv.css("width",f)}if(this._get(t,"isRTL")||n.left+t._mainDiv.outerWidth()-u>s){n.left=Math.max(r?0:u,i[0]+(t._input?t._input.outerWidth():0)-(r?u:0)-t._mainDiv.outerWidth()-(r&&e.browser.opera?document.documentElement.scrollLeft:0))}else{n.left-=r?u:0}if(n.top+t._mainDiv.outerHeight()-a>o){n.top=Math.max(r?0:a,i[1]-(r?a:0)-t._mainDiv.outerHeight()-(r&&e.browser.opera?document.documentElement.scrollTop:0))}else{n.top-=r?a:0}return n},_findPos:function(t){while(t&&(t.type=="hidden"||t.nodeType!=1)){t=t.nextSibling}var n=e(t).offset();return[n.left,n.top]},_hideKeypad:function(n,r){var i=this._curInst;if(!i||n&&i!=e.data(n,t)){return}if(this._keypadShowing){r=r!=null?r:this._get(i,"duration");r=r=="normal"&&e.ui&&e.ui.version>="1.8"?"_default":r;var s=this._get(i,"showAnim");if(e.effects&&e.effects[s]){i._mainDiv.hide(s,this._get(i,"showOptions"),r)}else{i._mainDiv[s=="slideDown"?"slideUp":s=="fadeIn"?"fadeOut":"hide"](s?r:"")}}var o=this._get(i,"onClose");if(o){o.apply(i._input?i._input[0]:null,[i._input.val(),i])}if(this._keypadShowing){this._keypadShowing=false;this._lastField=null}if(i._inline){i._input.val("")}this._curInst=null},_doKeyDown:function(t){if(t.keyCode==9){e.keypad.mainDiv.stop(true,true);e.keypad._hideKeypad()}},_checkExternalClick:function(t){if(!e.keypad._curInst){return}var n=e(t.target);if(!n.parents().andSelf().is("."+e.keypad._mainDivClass)&&!n.hasClass(e.keypad.markerClassName)&&!n.parents().andSelf().hasClass(e.keypad._triggerClass)&&e.keypad._keypadShowing){e.keypad._hideKeypad()}},_shiftKeypad:function(e){e.ucase=!e.ucase;this._updateKeypad(e);e._input.focus()},_clearValue:function(t){this._setValue(t,"",0);this._notifyKeypress(t,e.keypad.DEL)},_backValue:function(t){var n=t._input[0];var r=t._input.val();var i=[r.length,r.length];if(n.setSelectionRange){i=t._input.attr("readonly")||t._input.attr("disabled")?i:[n.selectionStart,n.selectionEnd]}else if(n.createTextRange){i=t._input.attr("readonly")||t._input.attr("disabled")?i:this._getIERange(n)}this._setValue(t,r.length==0?"":r.substr(0,i[0]-1)+r.substr(i[1]),i[0]-1);this._notifyKeypress(t,e.keypad.BS)},_selectValue:function(e,t){this.insertValue(e._input[0],t);this._setValue(e,e._input.val());this._notifyKeypress(e,t)},insertValue:function(t,n){t=t.jquery?t:e(t);var r=t[0];var i=t.val();var s=[i.length,i.length];if(r.setSelectionRange){s=t.attr("readonly")||t.attr("disabled")?s:[r.selectionStart,r.selectionEnd]}else if(r.createTextRange){s=t.attr("readonly")||t.attr("disabled")?s:this._getIERange(r)}t.val(i.substr(0,s[0])+n+i.substr(s[1]));pos=s[0]+n.length;if(t.is(":visible")){t.focus()}if(r.setSelectionRange){if(t.is(":visible")){r.setSelectionRange(pos,pos)}}else if(r.createTextRange){s=r.createTextRange();s.move("character",pos);s.select()}},_getIERange:function(e){e.focus();var t=document.selection.createRange().duplicate();var n=this._getIETextRange(e);n.setEndPoint("EndToStart",t);var r=function(e){var t=e.text;var n=t;var r=false;while(true){if(e.compareEndPoints("StartToEnd",e)==0){break}else{e.moveEnd("character",-1);if(e.text==t){n+="\r\n"}else{break}}}return n};var i=r(n);var s=r(t);return[i.length,i.length+s.length]},_getIETextRange:function(e){var t=e.nodeName.toLowerCase()=="input";var n=t?e.createTextRange():document.body.createTextRange();if(!t){n.moveToElementText(e)}return n},_setValue:function(e,t){var n=e._input.attr("maxlength");if(n>-1){t=t.substr(0,n)}e._input.val(t);if(!this._get(e,"onKeypress")){e._input.trigger("change")}},_notifyKeypress:function(e,t){var n=this._get(e,"onKeypress");if(n){n.apply(e._input?e._input[0]:null,[t,e._input.val(),e])}},_get:function(e,t){return e.settings[t]!==undefined?e.settings[t]:this._defaults[t]},_generateHTML:function(t){var n=this._get(t,"useThemeRoller");var r=this._get(t,"isRTL");var i=this._get(t,"prompt");var s=this._get(t,"separator");var o=!i?"":'<div class="keypad-prompt'+(n?" ui-widget-header ui-corner-all":"")+'">'+i+"</div>";var u=this._randomiseLayout(t);for(var a=0;a<u.length;a++){o+='<div class="keypad-row">';var f=u[a].split(s);for(var l=0;l<f.length;l++){if(t.ucase){f[l]=f[l].toUpperCase()}var c=this._specialKeys[f[l].charCodeAt(0)];if(c){o+=c.action?'<button type="button" class="keypad-special keypad-'+c.name+(n?" ui-corner-all ui-state-default"+(c.noHighlight?"":" ui-state-highlight"):"")+'" title="'+this._get(t,c.name+"Status")+'">'+(this._get(t,c.name+"Text")||" ")+"</button>":'<div class="keypad-'+c.name+'"></div>'}else{o+='<button type="button" '+'class="keypad-key'+(n?" ui-corner-all ui-state-default":"")+'">'+(f[l]==" "?" ":f[l])+"</button>"}}o+="</div>"}o+='<div style="clear: both;"></div>'+(!t._inline&&e.browser.msie&&parseInt(e.browser.version,10)<7?'<iframe src="javascript:false;" class="'+e.keypad._coverClass+'"></iframe>':"");o=e(o);var h=t;var p="keypad-key-down"+(n?" ui-state-active":"");o.find("button").mousedown(function(){e(this).addClass(p)}).mouseup(function(){e(this).removeClass(p)}).mouseout(function(){e(this).removeClass(p)}).filter(".keypad-key").click(function(){e.keypad._selectValue(h,e(this).text())});e.each(this._specialKeys,function(e,t){o.find(".keypad-"+t.name).click(function(){t.action.apply(h._input,[h])})});return o},_randomiseLayout:function(e){var t=this._get(e,"randomiseNumeric");var n=this._get(e,"randomiseAlphabetic");var r=this._get(e,"randomiseOther");var i=this._get(e,"randomiseAll");var s=this._get(e,"layout");if(!t&&!n&&!r&&!i){return s}var o=this._get(e,"isNumeric");var u=this._get(e,"isAlphabetic");var a=this._get(e,"separator");var f=[];var l=[];var c=[];var h=[];for(var p=0;p<s.length;p++){h[p]="";var d=s[p].split(a);for(var v=0;v<d.length;v++){if(this._isControl(d[v])){continue}if(i){c.push(d[v])}else if(o(d[v])){f.push(d[v])}else if(u(d[v])){l.push(d[v])}else{c.push(d[v])}}}if(t){this._shuffle(f)}if(n){this._shuffle(l)}if(r||i){this._shuffle(c)}var m=0;var g=0;var y=0;for(var p=0;p<s.length;p++){var d=s[p].split(a);for(var v=0;v<d.length;v++){h[p]+=(this._isControl(d[v])?d[v]:i?c[y++]:o(d[v])?f[m++]:u(d[v])?l[g++]:c[y++])+a}}return h},_isControl:function(e){return e<" "},isAlphabetic:function(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"},isNumeric:function(e){return e>="0"&&e<="9"},_shuffle:function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*e.length);var r=e[t];e[t]=e[n];e[n]=r}}});e.fn.keypad=function(t){var n=Array.prototype.slice.call(arguments,1);if(t=="isDisabled"){return e.keypad["_"+t+"Keypad"].apply(e.keypad,[this[0]].concat(n))}return this.each(function(){typeof t=="string"?e.keypad["_"+t+"Keypad"].apply(e.keypad,[this].concat(n)):e.keypad._attachKeypad(this,t)})};e.keypad=new n;e(function(){e(document.body).append(e.keypad.mainDiv).mousedown(e.keypad._checkExternalClick)})})(jQuery)
